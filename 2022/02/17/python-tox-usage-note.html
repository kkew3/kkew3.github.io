<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Python Tox 使用笔记 | Kaiwen’s personal website</title>
<meta name="generator" content="Jekyll v3.10.0">
<meta property="og:title" content="Python Tox 使用笔记">
<meta property="og:locale" content="en_US">
<meta name="description" content="Tox是一个项目自动化工具，在此记录下没在文档和网上tutorial找到的使用细节。试验中尽可能使用最小tox.ini。本文使用tox --showconfig -- &lt;args...&gt;的形式观察配置结果。如果文中没有提&lt;args...&gt;是什么（例如直接说“配置结果为”，而不是“运行…后配置结果为“），那么运行的是tox --showconfig。">
<meta property="og:description" content="Tox是一个项目自动化工具，在此记录下没在文档和网上tutorial找到的使用细节。试验中尽可能使用最小tox.ini。本文使用tox --showconfig -- &lt;args...&gt;的形式观察配置结果。如果文中没有提&lt;args...&gt;是什么（例如直接说“配置结果为”，而不是“运行…后配置结果为“），那么运行的是tox --showconfig。">
<link rel="canonical" href="https://kkew3.github.io/2022/02/17/python-tox-usage-note.html">
<meta property="og:url" content="https://kkew3.github.io/2022/02/17/python-tox-usage-note.html">
<meta property="og:site_name" content="Kaiwen’s personal website">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-02-17T11:07:47+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Python Tox 使用笔记">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-02-17T11:07:47+00:00","datePublished":"2022-02-17T11:07:47+00:00","description":"Tox是一个项目自动化工具，在此记录下没在文档和网上tutorial找到的使用细节。试验中尽可能使用最小tox.ini。本文使用tox --showconfig -- &lt;args...&gt;的形式观察配置结果。如果文中没有提&lt;args...&gt;是什么（例如直接说“配置结果为”，而不是“运行…后配置结果为“），那么运行的是tox --showconfig。","headline":"Python Tox 使用笔记","mainEntityOfPage":{"@type":"WebPage","@id":"https://kkew3.github.io/2022/02/17/python-tox-usage-note.html"},"url":"https://kkew3.github.io/2022/02/17/python-tox-usage-note.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
<link type="application/atom+xml" rel="alternate" href="https://kkew3.github.io/feed.xml" title="Kaiwen's personal website">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2YQN8LEHLR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2YQN8LEHLR');
</script>
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Kaiwen's personal website</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/tags/">Tags</a><a class="page-link" href="/docs/">Docs</a><a class="page-link" href="/about/">About</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Python Tox 使用笔记</h1>
    <span><a href="https://kkew3.github.io/tags/dev--python"><code class="highlighter-rouge"><nobr>dev/python</nobr></code></a></span>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-02-17T11:07:47+00:00" itemprop="datePublished">Feb 17, 2022 at 11:07:47
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href="https://tox.wiki/en/latest/index.html">Tox</a>是一个项目自动化工具，在此记录下没在文档和网上tutorial找到的使用细节。试验中尽可能使用最小<code class="language-plaintext highlighter-rouge">tox.ini</code>。本文使用<code class="language-plaintext highlighter-rouge">tox --showconfig -- &lt;args...&gt;</code>的形式观察配置结果。如果文中没有提<code class="language-plaintext highlighter-rouge">&lt;args...&gt;</code>是什么（例如直接说“配置结果为”，而不是“运行…后配置结果为“），那么运行的是<code class="language-plaintext highlighter-rouge">tox --showconfig</code>。</p>

<h2 id="默认basepython">默认<code class="language-plaintext highlighter-rouge">basepython</code>
</h2>

<h3 id="情况一">情况一</h3>
<p>令<code class="language-plaintext highlighter-rouge">tox.ini</code>为空。此时只有一个匿名虚拟环境。</p>

<p>配置结果为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...

[testenv:python]
...
basepython = /Library/Frameworks/Python.framework/Versions/3.9/bin/python3
...
</code></pre></div></div>

<p>这里的<code class="language-plaintext highlighter-rouge">/Library/Frameworks/Python.framework/Versions/3.9/bin/python3</code>是本机上按<code class="language-plaintext highlighter-rouge">PATH</code>顺序第一个遇到的Python解释器（注意这里既不是第一个<code class="language-plaintext highlighter-rouge">python</code>也不是第一个<code class="language-plaintext highlighter-rouge">python3</code>）。另外可以观察到，匿名虚拟环境被命名为<code class="language-plaintext highlighter-rouge">python</code>。</p>

<h3 id="情况二">情况二</h3>

<p>令<code class="language-plaintext highlighter-rouge">tox.ini</code>为</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[testenv:x]</span>
</code></pre></div></div>

<p>此时只有一个名为<code class="language-plaintext highlighter-rouge">x</code>的虚拟环境，<code class="language-plaintext highlighter-rouge">x</code>不与<a href="https://tox.wiki/en/latest/config.html#tox-environments">文档</a>中的任何一种特殊命名匹配。配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...

[testenv:x]
...
basepython = /Library/Frameworks/Python.framework/Versions/3.9/bin/python3
...
</code></pre></div></div>

<p>可见与情况一相同。</p>

<h3 id="情况三">情况三</h3>

<p>令<code class="language-plaintext highlighter-rouge">tox.ini</code>为</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[testenv:py28]</span>
</code></pre></div></div>

<p>此时只有一个名为<code class="language-plaintext highlighter-rouge">py28</code>的虚拟环境。配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...

[testenv:py28]
...
basepython = python2.8
...
</code></pre></div></div>

<p>我们知道是没有<code class="language-plaintext highlighter-rouge">python2.8</code>的，可见<code class="language-plaintext highlighter-rouge">tox</code>这里只是做了一个简单的从<code class="language-plaintext highlighter-rouge">pyMN</code>到<code class="language-plaintext highlighter-rouge">pythonM.N</code>的映射。此时如果运行<code class="language-plaintext highlighter-rouge">tox</code>的话是要报错的（即使<code class="language-plaintext highlighter-rouge">tox.ini</code>里加上<code class="language-plaintext highlighter-rouge">skipsdist = true</code>也会报错）：<code class="language-plaintext highlighter-rouge">ERROR: InterpreterNotFound: python2.8</code>。</p>

<h3 id="情况四">情况四</h3>

<p>令<code class="language-plaintext highlighter-rouge">tox.ini</code>为</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[testenv:py28]</span>
<span class="py">basepython</span> <span class="p">=</span> <span class="s">python2.7</span>
</code></pre></div></div>

<p>与情况三相同，但显式指定了<code class="language-plaintext highlighter-rouge">basepython</code>。配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...

[testenv:py28]
...
basepython = python2.7
...
</code></pre></div></div>

<p>可见显式指定的<code class="language-plaintext highlighter-rouge">basepython</code>生效了。</p>

<h2 id="posargs展开">
<code class="language-plaintext highlighter-rouge">{posargs}</code>展开</h2>

<h3 id="情况一-1">情况一</h3>

<p>令<code class="language-plaintext highlighter-rouge">tox.ini</code>为</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[testenv]</span>
<span class="py">commands</span> <span class="p">=</span> <span class="s">{posargs}</span>
</code></pre></div></div>

<p>运行<code class="language-plaintext highlighter-rouge">tox --showconfig</code>后（无参数），配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
commands = [[]]
...
</code></pre></div></div>

<p>可见<code class="language-plaintext highlighter-rouge">{posargs}</code>在无参数时展开为空字符串。</p>

<p>运行<code class="language-plaintext highlighter-rouge">tox --showconfig -- hello world</code>后（带参数），配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
commands = [['hello', 'world']]
...
</code></pre></div></div>

<p>在<code class="language-plaintext highlighter-rouge">{toxinidir}</code>下新建两个文件<code class="language-plaintext highlighter-rouge">hello1</code>和<code class="language-plaintext highlighter-rouge">hello2</code>，然后运行<code class="language-plaintext highlighter-rouge">tox --showconfig -- hello*</code>后（注意这里的运行环境不是Windows），配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
commands = [['hello1', 'hello2']]
...
</code></pre></div></div>

<p>这是符合期望的，因为Shell在传参前先做了Globbing，然而如果运行<code class="language-plaintext highlighter-rouge">tox --showconfig -- "hello*"</code>后，配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
commands = [['hello*']]
...
</code></pre></div></div>

<p>可见<code class="language-plaintext highlighter-rouge">{posargs}</code>不会做Globbing。</p>

<p>举一个运行<code class="language-plaintext highlighter-rouge">tox</code>的例子。令<code class="language-plaintext highlighter-rouge">tox.ini</code>为</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[tox]</span>
<span class="py">skipsdist</span> <span class="p">=</span> <span class="s">true</span>

<span class="nn">[testenv]</span>
<span class="py">allowlist_externals</span> <span class="p">=</span> <span class="s">ls</span>
<span class="py">commands</span> <span class="p">=</span> <span class="s">ls {posargs}</span>
</code></pre></div></div>

<p>如果运行<code class="language-plaintext highlighter-rouge">tox -- "hello*"</code>，我们会得到结果</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python run-test-pre: PYTHONHASHSEED='2558120981'
python run-test: commands[0] | ls 'hello*'
ls: hello*: No such file or directory
ERROR: InvocationError for command /bin/ls 'hello*' (exited with code 1)
_________________________ summary __________________________
ERROR:   python: commands failed
</code></pre></div></div>

<h3 id="情况二-1">情况二</h3>

<p>令<code class="language-plaintext highlighter-rouge">tox.ini</code>为</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[testenv]</span>
<span class="py">commands</span> <span class="p">=</span> <span class="s">"{posargs}"</span>
</code></pre></div></div>

<p>注意<code class="language-plaintext highlighter-rouge">{posargs}</code>两边的引号。运行<code class="language-plaintext highlighter-rouge">tox --showconfig</code>后（无参数），配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
commands = [['']]
...
</code></pre></div></div>

<p>可见虽然<code class="language-plaintext highlighter-rouge">{posargs}</code>在无参数时展开为空字符串，但现在有引号，导致仍产生了一个参数，只不过该参数值为空。</p>

<p>运行<code class="language-plaintext highlighter-rouge">tox --showconfig -- hello</code>后（一个参数），配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
commands = [['hello']]
...
</code></pre></div></div>

<p>没什么值得惊讶的。</p>

<p>运行<code class="language-plaintext highlighter-rouge">tox --showconfig -- hello world</code>后（多参数），配置结果为</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
commands = [['hello world']]
...
</code></pre></div></div>

<p>可见虽然<code class="language-plaintext highlighter-rouge">{posargs}</code>展开成了两个参数，但是引号又重新把它们括成了一个参数。</p>

  </div>
<a class="u-url" href="/2022/02/17/python-tox-usage-note.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaiwen's personal website</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaiwen's personal website</li>
<li><a class="u-email" href="mailto:kps6326@hotmail.com">kps6326@hotmail.com</a></li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/kkew3"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kkew3</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>My blogs and research reports.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
