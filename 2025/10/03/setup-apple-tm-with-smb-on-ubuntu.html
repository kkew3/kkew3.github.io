<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Setup Apple Time Machine network drive with Samba on Ubuntu 22.04 | Kaiwen’s personal website</title>
<meta name="generator" content="Jekyll v3.10.0">
<meta property="og:title" content="Setup Apple Time Machine network drive with Samba on Ubuntu 22.04">
<meta property="og:locale" content="en_US">
<meta name="description" content="The backup drive for my Mac’s Time Machine fails this morning. Therefore, I spent several hours working on setting up an Ubuntu 22.04 home server to serve as a network backup drive.">
<meta property="og:description" content="The backup drive for my Mac’s Time Machine fails this morning. Therefore, I spent several hours working on setting up an Ubuntu 22.04 home server to serve as a network backup drive.">
<link rel="canonical" href="https://kkew3.github.io/2025/10/03/setup-apple-tm-with-smb-on-ubuntu.html">
<meta property="og:url" content="https://kkew3.github.io/2025/10/03/setup-apple-tm-with-smb-on-ubuntu.html">
<meta property="og:site_name" content="Kaiwen’s personal website">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-10-03T04:25:14+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Setup Apple Time Machine network drive with Samba on Ubuntu 22.04">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-10-03T04:25:14+00:00","datePublished":"2025-10-03T04:25:14+00:00","description":"The backup drive for my Mac’s Time Machine fails this morning. Therefore, I spent several hours working on setting up an Ubuntu 22.04 home server to serve as a network backup drive.","headline":"Setup Apple Time Machine network drive with Samba on Ubuntu 22.04","mainEntityOfPage":{"@type":"WebPage","@id":"https://kkew3.github.io/2025/10/03/setup-apple-tm-with-smb-on-ubuntu.html"},"url":"https://kkew3.github.io/2025/10/03/setup-apple-tm-with-smb-on-ubuntu.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
<link type="application/atom+xml" rel="alternate" href="https://kkew3.github.io/feed.xml" title="Kaiwen's personal website">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2YQN8LEHLR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-2YQN8LEHLR');
</script>
</head>
<body>
<header class="site-header" role="banner">

  <div class="wrapper">
<a class="site-title" rel="author" href="/">Kaiwen's personal website</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>

        <div class="trigger">
<a class="page-link" href="/tags/">Tags</a><a class="page-link" href="/docs/">Docs</a><a class="page-link" href="/about/">About</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Setup Apple Time Machine network drive with Samba on Ubuntu 22.04</h1>
    <span><a href="https://kkew3.github.io/tags/dev--network"><code class="highlighter-rouge"><nobr>dev/network</nobr></code></a> | <a href="https://kkew3.github.io/tags/os--ubuntu"><code class="highlighter-rouge"><nobr>os/ubuntu</nobr></code></a></span>
    <p class="post-meta">
      <time class="dt-published" datetime="2025-10-03T04:25:14+00:00" itemprop="datePublished">Oct 3, 2025 at 04:25:14
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>The backup drive for my Mac’s Time Machine fails this morning.
Therefore, I spent several hours working on setting up an Ubuntu 22.04 home server to serve as a network backup drive.</p>

<h2 id="install-samba">Install Samba</h2>

<p>Reference: <a href="https://ubuntu.com/tutorials/install-and-configure-samba">https://ubuntu.com/tutorials/install-and-configure-samba</a>.</p>

<p>Install samba with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>samba
</code></pre></div></div>

<p>Then, set up a samba user account using the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>smbpasswd <span class="nt">-a</span> username
</code></pre></div></div>

<p>The command will prompt for a password for the new account.
Note that the username must belong to a system account.
In my case, I use the same username and password as the home server’s login user and password.</p>

<p>Samba comes with the following default config <code class="language-plaintext highlighter-rouge">/etc/samba/smb.conf</code>, which can be edited with <code class="language-plaintext highlighter-rouge">sudo vim /etc/samba/smb.conf</code>:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#
# Sample configuration file for the Samba suite for Debian GNU/Linux.
#
#
# This is the main Samba configuration file. You should read the
# smb.conf(5) manual page in order to understand the options listed
# here. Samba has a huge number of configurable options most of which
# are not shown in this example
#
# Some options that are often worth tuning have been included as
# commented-out examples in this file.
#  - When such options are commented with ";", the proposed setting
#    differs from the default Samba behaviour
#  - When commented with "#", the proposed setting is the default
#    behaviour of Samba but the option is considered important
#    enough to be mentioned here
#
# NOTE: Whenever you modify this file you should run the command
# "testparm" to check that you have not made any basic syntactic
# errors.
</span>
<span class="c">#======================= Global Settings =======================
</span>
[<span class="n">global</span>]

<span class="c">## Browsing/Identification ###
</span>
<span class="c"># Change this to the workgroup/NT-domain name your Samba server will part of
</span>   <span class="n">workgroup</span> = <span class="n">WORKGROUP</span>

<span class="c"># server string is the equivalent of the NT Description field
</span>   <span class="n">server</span> <span class="n">string</span> = %<span class="n">h</span> <span class="n">server</span> (<span class="n">Samba</span>, <span class="n">Ubuntu</span>)

<span class="c">#### Networking ####
</span>
<span class="c"># The specific set of interfaces / networks to bind to
# This can be either the interface name or an IP address/netmask;
# interface names are normally preferred
</span>;   <span class="n">interfaces</span> = <span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">0</span>/<span class="m">8</span> <span class="n">eth0</span>

<span class="c"># Only bind to the named interfaces and/or networks; you must use the
# 'interfaces' option above to use this.
# It is recommended that you enable this feature if your Samba machine is
# not protected by a firewall or is a firewall itself.  However, this
# option cannot handle dynamic or non-broadcast interfaces correctly.
</span>;   <span class="n">bind</span> <span class="n">interfaces</span> <span class="n">only</span> = <span class="n">yes</span>



<span class="c">#### Debugging/Accounting ####
</span>
<span class="c"># This tells Samba to use a separate log file for each machine
# that connects
</span>   <span class="n">log</span> <span class="n">file</span> = /<span class="n">var</span>/<span class="n">log</span>/<span class="n">samba</span>/<span class="n">log</span>.%<span class="n">m</span>

<span class="c"># Cap the size of the individual log files (in KiB).
</span>   <span class="n">max</span> <span class="n">log</span> <span class="n">size</span> = <span class="m">1000</span>

<span class="c"># We want Samba to only log to /var/log/samba/log.{smbd,nmbd}.
# Append syslog@1 if you want important messages to be sent to syslog too.
</span>   <span class="n">logging</span> = <span class="n">file</span>

<span class="c"># Do something sensible when Samba crashes: mail the admin a backtrace
</span>   <span class="n">panic</span> <span class="n">action</span> = /<span class="n">usr</span>/<span class="n">share</span>/<span class="n">samba</span>/<span class="n">panic</span>-<span class="n">action</span> %<span class="n">d</span>


<span class="c">####### Authentication #######
</span>
<span class="c"># Server role. Defines in which mode Samba will operate. Possible
# values are "standalone server", "member server", "classic primary
# domain controller", "classic backup domain controller", "active
# directory domain controller".
#
# Most people will want "standalone server" or "member server".
# Running as "active directory domain controller" will require first
# running "samba-tool domain provision" to wipe databases and create a
# new domain.
</span>   <span class="n">server</span> <span class="n">role</span> = <span class="n">standalone</span> <span class="n">server</span>

   <span class="n">obey</span> <span class="n">pam</span> <span class="n">restrictions</span> = <span class="n">yes</span>

<span class="c"># This boolean parameter controls whether Samba attempts to sync the Unix
# password with the SMB password when the encrypted SMB password in the
# passdb is changed.
</span>   <span class="n">unix</span> <span class="n">password</span> <span class="n">sync</span> = <span class="n">yes</span>

<span class="c"># For Unix password sync to work on a Debian GNU/Linux system, the following
# parameters must be set (thanks to Ian Kahan &lt;&lt;kahan@informatik.tu-muenchen.de&gt; for
# sending the correct chat script for the passwd program in Debian Sarge).
</span>   <span class="n">passwd</span> <span class="n">program</span> = /<span class="n">usr</span>/<span class="n">bin</span>/<span class="n">passwd</span> %<span class="n">u</span>
   <span class="n">passwd</span> <span class="n">chat</span> = *<span class="n">Enter</span>\<span class="n">snew</span>\<span class="n">s</span>*\<span class="n">spassword</span>:* %<span class="n">n</span>\<span class="n">n</span> *<span class="n">Retype</span>\<span class="n">snew</span>\<span class="n">s</span>*\<span class="n">spassword</span>:* %<span class="n">n</span>\<span class="n">n</span> *<span class="n">password</span>\<span class="n">supdated</span>\<span class="n">ssuccessfully</span>* .

<span class="c"># This boolean controls whether PAM will be used for password changes
# when requested by an SMB client instead of the program listed in
# 'passwd program'. The default is 'no'.
</span>   <span class="n">pam</span> <span class="n">password</span> <span class="n">change</span> = <span class="n">yes</span>

<span class="c"># This option controls how unsuccessful authentication attempts are mapped
# to anonymous connections
</span>   <span class="n">map</span> <span class="n">to</span> <span class="n">guest</span> = <span class="n">bad</span> <span class="n">user</span>


<span class="c">########## Domains ###########
</span>
<span class="c">#
# The following settings only takes effect if 'server role = classic
# primary domain controller', 'server role = classic backup domain controller'
# or 'domain logons' is set
#
</span>
<span class="c"># It specifies the location of the user's
# profile directory from the client point of view) The following
# required a [profiles] share to be setup on the samba server (see
# below)
</span>;   <span class="n">logon</span> <span class="n">path</span> = \%<span class="n">N</span>\<span class="n">profiles</span>\%<span class="n">U</span>
<span class="c"># Another common choice is storing the profile in the user's home directory
# (this is Samba's default)
#   logon path = \%N\%U\profile
</span>
<span class="c"># The following setting only takes effect if 'domain logons' is set
# It specifies the location of a user's home directory (from the client
# point of view)
</span>;   <span class="n">logon</span> <span class="n">drive</span> = <span class="n">H</span>:
<span class="c">#   logon home = \%N\%U
</span>
<span class="c"># The following setting only takes effect if 'domain logons' is set
# It specifies the script to run during logon. The script must be stored
# in the [netlogon] share
# NOTE: Must be store in 'DOS' file format convention
</span>;   <span class="n">logon</span> <span class="n">script</span> = <span class="n">logon</span>.<span class="n">cmd</span>

<span class="c"># This allows Unix users to be created on the domain controller via the SAMR
# RPC pipe.  The example command creates a user account with a disabled Unix
# password; please adapt to your needs
</span>; <span class="n">add</span> <span class="n">user</span> <span class="n">script</span> = /<span class="n">usr</span>/<span class="n">sbin</span>/<span class="n">adduser</span> --<span class="n">quiet</span> --<span class="n">disabled</span>-<span class="n">password</span> --<span class="n">gecos</span> <span class="s2">""</span> %<span class="n">u</span>

<span class="c"># This allows machine accounts to be created on the domain controller via the
# SAMR RPC pipe.
# The following assumes a "machines" group exists on the system
</span>; <span class="n">add</span> <span class="n">machine</span> <span class="n">script</span>  = /<span class="n">usr</span>/<span class="n">sbin</span>/<span class="n">useradd</span> -<span class="n">g</span> <span class="n">machines</span> -<span class="n">c</span> <span class="s2">"%u machine account"</span> -<span class="n">d</span> /<span class="n">var</span>/<span class="n">lib</span>/<span class="n">samba</span> -<span class="n">s</span> /<span class="n">bin</span>/<span class="n">false</span> %<span class="n">u</span>

<span class="c"># This allows Unix groups to be created on the domain controller via the SAMR
# RPC pipe.
</span>; <span class="n">add</span> <span class="n">group</span> <span class="n">script</span> = /<span class="n">usr</span>/<span class="n">sbin</span>/<span class="n">addgroup</span> --<span class="n">force</span>-<span class="n">badname</span> %<span class="n">g</span>

<span class="c">############ Misc ############
</span>
<span class="c"># Using the following line enables you to customise your configuration
# on a per machine basis. The %m gets replaced with the netbios name
# of the machine that is connecting
</span>;   <span class="n">include</span> = /<span class="n">home</span>/<span class="n">samba</span>/<span class="n">etc</span>/<span class="n">smb</span>.<span class="n">conf</span>.%<span class="n">m</span>

<span class="c"># Some defaults for winbind (make sure you're not using the ranges
# for something else.)
</span>;   <span class="n">idmap</span> <span class="n">config</span> * :              <span class="n">backend</span> = <span class="n">tdb</span>
;   <span class="n">idmap</span> <span class="n">config</span> * :              <span class="n">range</span>   = <span class="m">3000</span>-<span class="m">7999</span>
;   <span class="n">idmap</span> <span class="n">config</span> <span class="n">YOURDOMAINHERE</span> : <span class="n">backend</span> = <span class="n">tdb</span>
;   <span class="n">idmap</span> <span class="n">config</span> <span class="n">YOURDOMAINHERE</span> : <span class="n">range</span>   = <span class="m">100000</span>-<span class="m">999999</span>
;   <span class="n">template</span> <span class="n">shell</span> = /<span class="n">bin</span>/<span class="n">bash</span>

<span class="c"># Setup usershare options to enable non-root users to share folders
# with the net usershare command.
</span>
<span class="c"># Maximum number of usershare. 0 means that usershare is disabled.
#   usershare max shares = 100
</span>
<span class="c"># Allow users who've been granted usershare privileges to create
# public shares, not just authenticated ones
</span>   <span class="n">usershare</span> <span class="n">allow</span> <span class="n">guests</span> = <span class="n">yes</span>

<span class="c">#======================= Share Definitions =======================
</span>
<span class="c"># Un-comment the following (and tweak the other settings below to suit)
# to enable the default home directory shares. This will share each
# user's home directory as \server\username
</span>;[<span class="n">homes</span>]
;   <span class="n">comment</span> = <span class="n">Home</span> <span class="n">Directories</span>
;   <span class="n">browseable</span> = <span class="n">no</span>

<span class="c"># By default, the home directories are exported read-only. Change the
# next parameter to 'no' if you want to be able to write to them.
</span>;   <span class="n">read</span> <span class="n">only</span> = <span class="n">yes</span>

<span class="c"># File creation mask is set to 0700 for security reasons. If you want to
# create files with group=rw permissions, set next parameter to 0775.
</span>;   <span class="n">create</span> <span class="n">mask</span> = <span class="m">0700</span>

<span class="c"># Directory creation mask is set to 0700 for security reasons. If you want to
# create dirs. with group=rw permissions, set next parameter to 0775.
</span>;   <span class="n">directory</span> <span class="n">mask</span> = <span class="m">0700</span>

<span class="c"># By default, \server\username shares can be connected to by anyone
# with access to the samba server.
# Un-comment the following parameter to make sure that only "username"
# can connect to \server\username
# This might need tweaking when using external authentication schemes
</span>;   <span class="n">valid</span> <span class="n">users</span> = %<span class="n">S</span>

<span class="c"># Un-comment the following and create the netlogon directory for Domain Logons
# (you need to configure Samba to act as a domain controller too.)
</span>;[<span class="n">netlogon</span>]
;   <span class="n">comment</span> = <span class="n">Network</span> <span class="n">Logon</span> <span class="n">Service</span>
;   <span class="n">path</span> = /<span class="n">home</span>/<span class="n">samba</span>/<span class="n">netlogon</span>
;   <span class="n">guest</span> <span class="n">ok</span> = <span class="n">yes</span>
;   <span class="n">read</span> <span class="n">only</span> = <span class="n">yes</span>

<span class="c"># Un-comment the following and create the profiles directory to store
# users profiles (see the "logon path" option above)
# (you need to configure Samba to act as a domain controller too.)
# The path below should be writable by all users so that their
# profile directory may be created the first time they log on
</span>;[<span class="n">profiles</span>]
;   <span class="n">comment</span> = <span class="n">Users</span> <span class="n">profiles</span>
;   <span class="n">path</span> = /<span class="n">home</span>/<span class="n">samba</span>/<span class="n">profiles</span>
;   <span class="n">guest</span> <span class="n">ok</span> = <span class="n">no</span>
;   <span class="n">browseable</span> = <span class="n">no</span>
;   <span class="n">create</span> <span class="n">mask</span> = <span class="m">0600</span>
;   <span class="n">directory</span> <span class="n">mask</span> = <span class="m">0700</span>

[<span class="n">printers</span>]
   <span class="n">comment</span> = <span class="n">All</span> <span class="n">Printers</span>
   <span class="n">browseable</span> = <span class="n">no</span>
   <span class="n">path</span> = /<span class="n">var</span>/<span class="n">spool</span>/<span class="n">samba</span>
   <span class="n">printable</span> = <span class="n">yes</span>
   <span class="n">guest</span> <span class="n">ok</span> = <span class="n">no</span>
   <span class="n">read</span> <span class="n">only</span> = <span class="n">yes</span>
   <span class="n">create</span> <span class="n">mask</span> = <span class="m">0700</span>

<span class="c"># Windows clients look for this share name as a source of downloadable
# printer drivers
</span>[<span class="n">print</span>$]
   <span class="n">comment</span> = <span class="n">Printer</span> <span class="n">Drivers</span>
   <span class="n">path</span> = /<span class="n">var</span>/<span class="n">lib</span>/<span class="n">samba</span>/<span class="n">printers</span>
   <span class="n">browseable</span> = <span class="n">yes</span>
   <span class="n">read</span> <span class="n">only</span> = <span class="n">yes</span>
   <span class="n">guest</span> <span class="n">ok</span> = <span class="n">no</span>
<span class="c"># Uncomment to allow remote administration of Windows print drivers.
# You may need to replace 'lpadmin' with the name of the group your
# admin users are members of.
# Please note that you also need to set appropriate Unix permissions
# to the drivers directory for these users to have write rights in it
</span>;   <span class="n">write</span> <span class="n">list</span> = <span class="n">root</span>, @<span class="n">lpadmin</span>
</code></pre></div></div>

<p>I delete the printer sections:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff --git 1/smb.conf 2/smb.conf
index 8fe8be8..55c516a 100644
</span><span class="gd">--- 1/smb.conf
</span><span class="gi">+++ 2/smb.conf
</span><span class="p">@@ -217,23 +217,23 @@</span>
 ;   create mask = 0600
 ;   directory mask = 0700
 
<span class="gd">-[printers]
-   comment = All Printers
-   browseable = no
-   path = /var/spool/samba
-   printable = yes
-   guest ok = no
-   read only = yes
-   create mask = 0700
</span><span class="gi">+#[printers]
+#   comment = All Printers
+#   browseable = no
+#   path = /var/spool/samba
+#   printable = yes
+#   guest ok = no
+#   read only = yes
+#   create mask = 0700
</span> 
 # Windows clients look for this share name as a source of downloadable
 # printer drivers
<span class="gd">-[print$]
-   comment = Printer Drivers
-   path = /var/lib/samba/printers
-   browseable = yes
-   read only = yes
-   guest ok = no
</span><span class="gi">+#[print$]
+#   comment = Printer Drivers
+#   path = /var/lib/samba/printers
+#   browseable = yes
+#   read only = yes
+#   guest ok = no
</span> # Uncomment to allow remote administration of Windows print drivers.
 # You may need to replace 'lpadmin' with the name of the group your
 # admin users are members of.
</code></pre></div></div>

<h2 id="setup-samba-for-time-machine">Setup Samba for Time Machine</h2>

<p>Reference: <a href="https://blog.jhnr.ch/2023/01/09/setup-apple-time-machine-network-drive-with-samba-on-ubuntu-22.04/">https://blog.jhnr.ch/2023/01/09/setup-apple-time-machine-network-drive-with-samba-on-ubuntu-22.04/</a>.</p>

<p>To make Samba work we need <code class="language-plaintext highlighter-rouge">samba-vfs-modules</code> package.
Install it with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>samba-vfs-modules
</code></pre></div></div>

<p>Create the backup directory in the home server:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /data/MyMacTimeMachine
</code></pre></div></div>

<p>We further configure <code class="language-plaintext highlighter-rouge">/etc/samba/smb.conf</code> as what follows:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff --git 2/smb.conf 3/smb.conf
index 55c516a..98b10c5 100644
</span><span class="gd">--- 2/smb.conf
</span><span class="gi">+++ 3/smb.conf
</span><span class="p">@@ -99,6 +99,21 @@</span>
 # to anonymous connections
    map to guest = bad user
 
<span class="gi">+# Fruit global config
+   fruit:aapl = yes
+   fruit:nfs_aces = no
+   fruit:copyfile = no
+   fruit:model = MacSamba
+
+   inherit permissions = yes
+   multicast dns register = no
+
+# Protocol versions
+   client max protocol = default
+   client min protocol = SMB2_02
+   server max protocol = SMB3
+   server min protocol = SMB2_02
+
</span> 
 ########## Domains ###########
 
<span class="p">@@ -240,3 +255,15 @@</span>
 # Please note that you also need to set appropriate Unix permissions
 # to the drivers directory for these users to have write rights in it
 ;   write list = root, @lpadmin
<span class="gi">+
+[myMacTimeMachine]
+   vfs objects = catia fruit streams_xattr
+   fruit:time machine = yes
+   fruit:time machine max size = 500G
+   comment = Time Machine backup
+   path = /data/MyMacTimeMachine
+   available = yes
+   valid users = kw
+   browseable = yes
+   guest ok = no
+   writable = yes
</span></code></pre></div></div>

<p>In my case, I set the section name as <code class="language-plaintext highlighter-rouge">myMacTimeMachine</code>.
I’m not sure what characters are safe to use, but alphanumeric characters should be okay.</p>

<h2 id="setup-avahi-daemon-for-time-machine">Setup avahi-daemon for Time Machine</h2>

<p>Quoted from Johner’s post above:</p>

<blockquote>
  <p>Basically Samba shares the network drive and avahi makes it work with apple devices by implementing Apple’s Zeroconf architecture (also known as “Rendezvous” or “Bonjour”).</p>
</blockquote>

<p>Install with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>avahi-daemon
</code></pre></div></div>

<p>Create an avahi config file with <code class="language-plaintext highlighter-rouge">sudo vim /etc/avahi/services/samba.service</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" standalone='no'?&gt;</span>
<span class="cp">&lt;!DOCTYPE service-group SYSTEM "avahi-service.dtd"&gt;</span>
<span class="nt">&lt;service-group&gt;</span>
  <span class="nt">&lt;name</span> <span class="na">replace-wildcards=</span><span class="s">"yes"</span><span class="nt">&gt;</span>%h<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;type&gt;</span>_smb._tcp<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;port&gt;</span>445<span class="nt">&lt;/port&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;type&gt;</span>_device-info._tcp<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;port&gt;</span>0<span class="nt">&lt;/port&gt;</span>
    <span class="nt">&lt;txt-record&gt;</span>model=TimeCapsule8,119<span class="nt">&lt;/txt-record&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
  <span class="nt">&lt;service&gt;</span>
    <span class="nt">&lt;type&gt;</span>_adisk._tcp<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;txt-record&gt;</span>dk0=adVN=timemachine,adVF=0x82<span class="nt">&lt;/txt-record&gt;</span>
    <span class="nt">&lt;txt-record&gt;</span>sys=waMa=0,adVF=0x100<span class="nt">&lt;/txt-record&gt;</span>
  <span class="nt">&lt;/service&gt;</span>
<span class="nt">&lt;/service-group&gt;</span>
</code></pre></div></div>

<p>Be sure to fill the section name of <code class="language-plaintext highlighter-rouge">/etc/samba/smb.conf</code> in the first <code class="language-plaintext highlighter-rouge">&lt;txt-record&gt;</code>:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff --git 1/samba.service 2/samba.service
index c516aac..5651005 100644
</span><span class="gd">--- 1/samba.service
</span><span class="gi">+++ 2/samba.service
</span><span class="p">@@ -13,7 +13,7 @@</span>
   &lt;/service&gt;
   &lt;service&gt;
     &lt;type&gt;_adisk._tcp&lt;/type&gt;
<span class="gd">-    &lt;txt-record&gt;dk0=adVN=timemachine,adVF=0x82&lt;/txt-record&gt;
</span><span class="gi">+    &lt;txt-record&gt;dk0=adVN=myMacTimeMachine,adVF=0x82&lt;/txt-record&gt;
</span>     &lt;txt-record&gt;sys=waMa=0,adVF=0x100&lt;/txt-record&gt;
   &lt;/service&gt;
 &lt;/service-group&gt;
</code></pre></div></div>

<h2 id="run-the-services">Run the services</h2>

<p>Reference: <a href="https://ubuntu.com/tutorials/install-and-configure-samba">https://ubuntu.com/tutorials/install-and-configure-samba</a>.</p>

<p>Update the firewall rules:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>ufw allow samba
</code></pre></div></div>

<p>Reference: <a href="https://gist.github.com/davisford/5984768">https://gist.github.com/davisford/5984768</a>.</p>

<p>Finally (re)start the services.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>service smbd restart
<span class="nb">sudo </span>systemctl restart avahi-daemon
</code></pre></div></div>

<p>These two commands should be rerun every time the <code class="language-plaintext highlighter-rouge">/etc/samba/smb.conf</code> config file is updated.</p>

<h2 id="configure-time-machine-on-mac-side">Configure Time Machine on Mac side</h2>

<p>Open <code class="language-plaintext highlighter-rouge">System Preferences &gt; Time Machine &gt; Select Disk</code>.
The samba shared folder <code class="language-plaintext highlighter-rouge">myMacTimeMachine</code> should now appear in the <code class="language-plaintext highlighter-rouge">Available Disks</code> list.</p>

  </div>
<a class="u-url" href="/2025/10/03/setup-apple-tm-with-smb-on-ubuntu.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Kaiwen's personal website</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kaiwen's personal website</li>
<li><a class="u-email" href="mailto:kps6326@hotmail.com">kps6326@hotmail.com</a></li>
</ul>
      </div>

      <div class="footer-col footer-col-2">
<ul class="social-media-list"><li><a href="https://github.com/kkew3"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">kkew3</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>My blogs and research reports.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
